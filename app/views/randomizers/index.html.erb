<% content_for :title, "Randomizers" %>

<div class="w-full">
  <!-- Tab Content -->
  <%= turbo_frame_tag "randomizers" do %>
    <!-- Header Section with Border -->
    <div class="border-b border-base-300 pb-6 mb-8">
      <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6 mb-6">
        <!-- Tab Navigation -->
        <div role="tablist" class="tabs tabs-lifted tabs-lg">
          <%= link_to randomizers_path(tab: 'newest', query: params[:query], tags: @tags), 
              class: "tab font-semibold #{@tab == 'newest' ? 'tab-active [--tab-bg:hsl(var(--b2))] [--tab-border-color:hsl(var(--b3))]' : ''}", 
              data: { turbo_frame: "randomizers", turbo_action: "advance" } do %>
            Newest
          <% end %>
          
          <%= link_to randomizers_path(tab: 'most_liked', query: params[:query], tags: @tags), 
              class: "tab font-semibold #{@tab == 'most_liked' ? 'tab-active [--tab-bg:hsl(var(--b2))] [--tab-border-color:hsl(var(--b3))]' : ''}", 
              data: { turbo_frame: "randomizers", turbo_action: "advance" } do %>
            Most Liked
          <% end %>
          
          <%= link_to randomizers_path(tab: 'your_likes', query: params[:query], tags: @tags), 
              class: "tab font-semibold #{@tab == 'your_likes' ? 'tab-active [--tab-bg:hsl(var(--b2))] [--tab-border-color:hsl(var(--b3))]' : ''}", 
              data: { turbo_frame: current_user ? "randomizers" : "_top", turbo_action: current_user ? "advance" : "replace" } do %>
            Your Likes
          <% end %>
          
          <%= link_to randomizers_path(tab: 'your_randomizers', query: params[:query], tags: @tags), 
              class: "tab font-semibold #{@tab == 'your_randomizers' ? 'tab-active [--tab-bg:hsl(var(--b2))] [--tab-border-color:hsl(var(--b3))]' : ''}", 
              data: { turbo_frame: current_user ? "randomizers" : "_top", turbo_action: current_user ? "advance" : "replace" } do %>
            Your Randomizers
          <% end %>
        </div>

        <!-- Search Bar -->
        <div data-controller="search" class="w-full lg:w-auto">
          <%= form_with url: randomizers_path, method: :get, 
              data: { search_target: "form", turbo_frame: "randomizers", turbo_action: "advance" } do |f| %>
            <%= f.hidden_field :tab, value: @tab %>
            <% Array(@tags).each do |tag| %>
              <%= hidden_field_tag 'tags[]', tag %>
            <% end %>
            <div class="relative">
              <%= f.text_field :query, 
                  placeholder: "Search randomizers...", 
                  class: "input input-bordered input-handwritten w-full lg:w-72 pl-10",
                  value: params[:query],
                  data: { action: "input->search#submit", search_target: "input" } %>
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-base-content/50">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
              </div>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Tag Filter Pills -->
      <% if Tag.exists? %>
        <div class="flex flex-wrap gap-2 items-center">
          <span class="text-sm font-semibold mr-2 opacity-70">Filter by:</span>
          <% Tag.order(:name).each do |tag| %>
            <%= link_to tag.name,
                toggle_tag_url(tag.name),
                class: "badge #{tag_active?(tag.name) ? 'bg-base-content text-base-100 border-base-content' : 'bg-base-100 text-base-content border-base-content'} font-handwriting text-base hover:bg-base-content hover:text-base-100 transition-colors",
                data: { turbo_frame: "randomizers", turbo_action: "advance" } %>
          <% end %>
          <% if @tags.present? %>
            <%= link_to "Clear filters", randomizers_path(tab: @tab, query: params[:query]),
                class: "btn btn-ghost btn-xs text-error hover:bg-error/10 ml-2 font-handwriting",
                data: { turbo_frame: "randomizers", turbo_action: "advance" } %>
          <% end %>
        </div>
      <% end %>
    </div>

    <div class="grid grid-cols-[repeat(auto-fill,minmax(24rem,1fr))] gap-4">

      <!-- New Randomizer Card (appears on all tabs) -->
      <div class="card-index flex flex-col group p-4 min-h-[220px] transition-transform hover:-rotate-1">
        <%= link_to new_randomizer_path,
                    class: "flex-1 flex flex-col no-underline text-inherit",
                    data: { turbo_frame: "_top" } do %>

          <h2 class="card-title text-xl font-bold mb-2 font-typewriter border-b border-red-300 pb-1">New Randomizer</h2>

          <p class="flex-1 text-base-content/70 font-handwriting text-lg">
            Create your own!
          </p>

        <% end %>
      </div>

      <% if @randomizers.empty? %>
        <div class="card-index flex flex-col items-center justify-center p-8 min-h-[220px] border-4 border-dashed border-base-content/20 rounded-box text-base-content/40 rotate-1 select-none grayscale">
          <%= icon 'mood-sad', variant: :outline, class: "w-16 h-16 mb-2 stroke-1 opacity-50" %>
          <p class="font-handwriting text-2xl text-center">
            No randomizers found...
          </p>
          <% if params[:query].present? %>
            <p class="font-handwriting text-lg text-center mt-2 opacity-75">
              matching "<%= params[:query] %>"
            </p>
          <% end %>
        </div>
      <% end %>

      <!-- Existing Randomizer Cards with artwork inserted at random position -->
      <% artwork = random_card_artwork %>
      <% artwork_position = random_artwork_position %>
      <% @randomizers.each_with_index do |randomizer, index| %>
        <% if index + 2 == artwork_position %>
          <!-- D&D Artwork Card (randomly positioned) -->
          <div class="card-index flex flex-col items-center justify-center p-4 min-h-[220px] max-h-[220px] overflow-hidden transition-transform hover:rotate-1 grayscale hover:grayscale-0 transition-all duration-300">
            <%= image_tag "cards/#{artwork}.png", 
                          alt: "D&D #{artwork.titleize}", 
                          class: "w-full h-full object-cover" %>
          </div>
        <% end %>
        <div id="<%= dom_id(randomizer) %>" class="card-index flex flex-col group p-4 min-h-[220px] transition-transform hover:-rotate-1 relative">
        
        <!-- Tag Badges (Push Pin Style) -->
        <% if randomizer.tags.any? %>
          <div class="absolute -top-3 left-1/2 -translate-x-1/2 z-20 flex gap-2">
            <% randomizer.tags.each do |tag| %>
              <%= link_to tag.name,
                  randomizers_path(tag: tag.name),
                  class: "badge badge-outline border-2 border-gray-300 bg-base-100 text-gray-600 hover:border-pencil hover:text-pencil transition-all font-handwriting text-sm shadow-sm transform hover:scale-105",
                  data: { turbo_frame: "_top" },
                  onclick: "event.stopPropagation();" %>
            <% end %>
          </div>
        <% end %>
        
        <!-- Like Button (Top Right) -->
        <div class="absolute top-4 right-4 z-10" id="<%= dom_id(randomizer, :like_button) %>">
          <%= button_to toggle_like_randomizer_path(randomizer),
                method: :post,
                data: { turbo_stream: true },
                class: "text-pencil hover:text-red-600 transition flex items-center gap-1 px-2 py-1" do %>
            <span class="text-sm font-bold font-typewriter"><%= randomizer.cached_votes_total %></span>
            <% icon_variant = current_user&.voted_for?(randomizer) ? :filled : :outline %>
            <%= icon 'thumb-up', variant: icon_variant, class: "w-4 h-4" %>
          <% end %>
        </div>

        <%= link_to randomizer_outcomes_path(randomizer),
                    class: "flex-1 flex flex-col no-underline text-inherit pt-1",
                    data: { turbo_frame: "_top" } do %>

          <h2 class="card-title text-xl font-bold mb-3 pr-16 font-typewriter border-b border-red-300 pb-1 line-clamp-1">
            <%= randomizer.name %>
          </h2>

          <div class="flex-1 text-pencil/80 flex flex-col gap-1 font-handwriting text-lg">
            <% randomizer.rolls.first(2).each do |roll| %>
              <div class="leading-tight flex items-center gap-2">
                <span class="font-medium"><%= roll.name || 'Missing' %></span>
                <span class="text-sm text-pencil/60"><%= roll.dice %></span>
              </div>
            <% end %>
            <% if randomizer.rolls.count > 2 %>
              <div class="text-sm text-pencil/60 italic mt-1">...and more</div>
            <% end %>
          </div>

        <% end %>

        <div class="card-actions grid grid-cols-3 items-center mt-4 border-t border-blue-200 pt-3">
          <!-- Owner Avatar and Edit Button (Left) -->
          <div class="flex items-center gap-2 justify-self-start">
            <% if randomizer.user&.email.present? %>
              <%= image_tag gravatar_url(randomizer.user, size: 32),
                            alt: "#{randomizer.user.display_name}'s avatar",
                            title: "Created by #{randomizer.user.display_name}",
                            class: "w-8 h-8 rounded-full border border-gray-400 grayscale hover:grayscale-0 transition-all" %>
            <% end %>
            
            <% if current_user == randomizer.user %>
              <%= link_to randomizer,
                          class: "text-pencil/50 hover:text-pencil p-1 rounded flex items-center gap-1 transition-colors",
                          title: "Edit",
                          data: { turbo_frame: "_top" } do %>
                <%= icon(:edit, class: "w-4 h-4") %>
              <% end %>
            <% end %>
          </div>

          <!-- Delete Button (Center) -->
          <div class="justify-self-center">
            <% if current_user == randomizer.user && @tab == 'your_randomizers' %>
              <%= button_to randomizer_path(randomizer, tab: @tab),
                            method: :delete,
                            data: { turbo_confirm: "Are you sure you want to delete this randomizer?" },
                            class: "text-pencil/30 hover:text-red-600 p-2 transition-colors flex items-center justify-center",
                            title: "Delete" do %>
                <%= icon(:trash, class: "w-4 h-4") %>
              <% end %>
            <% end %>
          </div>

          <!-- Share Button (Right) -->
          <div class="flex items-center gap-2 relative justify-self-end" data-controller="clipboard" data-clipboard-url-value="<%= randomizer_url(randomizer) %>">
            
            <!-- Copied Notification (Left of button) -->
            <div data-clipboard-target="notification"
                 class="absolute right-full top-1/2 -translate-y-1/2 mr-3 bg-black text-white px-2 py-1 rounded text-xs whitespace-nowrap opacity-0 hidden pointer-events-none transition-all duration-200 z-20 font-typewriter">
              Copied!
            </div>

            <button data-action="click->clipboard#copy"
                    class="text-pencil hover:text-blue-600 transition flex items-center gap-1 p-2"
                    title="Copy link to clipboard">
              <%= icon 'share', variant: :outline, class: "w-5 h-5" %>
            </button>
          </div>
        </div>
      </div>

      <% end %>
    </div>
  <% end %>
</div>
