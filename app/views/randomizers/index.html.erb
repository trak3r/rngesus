<% content_for :title, "Randomizers" %>

<div class="w-full">
  <!-- Tab Content -->
  <%= turbo_frame_tag "randomizers" do %>
    <!-- Tabs and Search Bar on Same Line -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
      <!-- Tab Navigation -->
      <div role="tablist" class="tabs tabs-lifted tabs-lg">
        <%= link_to randomizers_path(tab: 'newest', query: params[:query]), 
            class: "tab font-semibold #{@tab == 'newest' ? 'tab-active [--tab-bg:hsl(var(--b2))] [--tab-border-color:hsl(var(--b3))]' : ''}", 
            data: { turbo_frame: "randomizers", turbo_action: "advance" } do %>
          Newest
        <% end %>
        
        <%= link_to randomizers_path(tab: 'most_liked', query: params[:query]), 
            class: "tab font-semibold #{@tab == 'most_liked' ? 'tab-active [--tab-bg:hsl(var(--b2))] [--tab-border-color:hsl(var(--b3))]' : ''}", 
            data: { turbo_frame: "randomizers", turbo_action: "advance" } do %>
          Most Liked
        <% end %>
        
        <%= link_to randomizers_path(tab: 'your_likes', query: params[:query]), 
            class: "tab font-semibold #{@tab == 'your_likes' ? 'tab-active [--tab-bg:hsl(var(--b2))] [--tab-border-color:hsl(var(--b3))]' : ''}", 
            data: { turbo_frame: current_user ? "randomizers" : "_top", turbo_action: current_user ? "advance" : "replace" } do %>
          Your Likes
        <% end %>
        
        <%= link_to randomizers_path(tab: 'your_randomizers', query: params[:query]), 
            class: "tab font-semibold #{@tab == 'your_randomizers' ? 'tab-active [--tab-bg:hsl(var(--b2))] [--tab-border-color:hsl(var(--b3))]' : ''}", 
            data: { turbo_frame: current_user ? "randomizers" : "_top", turbo_action: current_user ? "advance" : "replace" } do %>
          Your Randomizers
        <% end %>
      </div>

      <!-- Search Bar -->
      <div data-controller="search">
        <%= form_with url: randomizers_path, method: :get, 
            data: { search_target: "form", turbo_frame: "randomizers", turbo_action: "advance" } do |f| %>
          <%= f.hidden_field :tab, value: @tab %>
          <%= f.text_field :query, 
              placeholder: "Search randomizers...", 
              class: "input input-bordered w-full sm:w-64",
              value: params[:query],
              data: { action: "input->search#submit", search_target: "input" } %>
        <% end %>
      </div>
    </div>

    <div class="flex flex-wrap gap-4">
      <% if @randomizers.empty? %>
        <div class="w-full text-center p-8 text-base-content/50">
          No randomizers found<%= " matching \"#{params[:query]}\"" if params[:query].present? %>
        </div>
      <% end %>

      <!-- New Randomizer Card (appears on all tabs) -->
      <div class="card bg-base-100 w-96 shadow-sm flex flex-col group
                   p-4 min-h-[180px]
                  bg-gradient-to-b from-base-100 to-base-200">
        <%= link_to new_randomizer_path,
                    class: "flex-1 flex flex-col no-underline text-inherit",
                    data: { turbo_frame: "_top" } do %>

          <h2 class="card-title text-xl font-bold mb-2">New Randomizer</h2>

          <p class="flex-1 text-base-content/70">
            Create your own!
          </p>

        <% end %>
      </div>

      <!-- Randomizer Cards -->
      <% @randomizers.each do |randomizer| %>

      <div class="card w-96 shadow-sm flex flex-col group p-4 min-h-[180px] relative
                  bg-gradient-to-br from-primary/5 to-primary/10
                  hover:from-primary/10 hover:to-primary/20 transition-all duration-200">
        
        <!-- Like Button (Top Right) -->
        <div class="absolute top-4 right-4 z-10" id="<%= dom_id(randomizer, :like_button) %>">
          <%= button_to toggle_like_randomizer_path(randomizer),
                method: :post,
                data: { turbo_stream: true },
                class: "text-primary hover:text-secondary transition flex items-center gap-1 bg-base-100/50 px-2 py-1 rounded-full hover:bg-base-100 shadow-sm" do %>
            <span class="text-sm font-bold"><%= randomizer.cached_votes_total %></span>
            <% icon_variant = current_user&.voted_for?(randomizer) ? :filled : :outline %>
            <%= icon 'thumb-up', variant: icon_variant, class: "w-4 h-4" %>
          <% end %>
        </div>

        <%= link_to randomizer_outcomes_path(randomizer),
                    class: "flex-1 flex flex-col no-underline text-inherit pt-1",
                    data: { turbo_frame: "_top" } do %>

          <h2 class="card-title text-xl font-bold mb-3 pr-16">
            <%= randomizer.name %>
          </h2>

          <div class="flex-1 text-base-content/70 flex flex-col gap-1">
            <% randomizer.rolls.each do |roll| %>
              <div class="leading-tight flex items-center gap-2">
                <span class="font-medium"><%= roll.name || 'Missing' %></span>
                <span class="text-sm text-base-content/60"><%= roll.dice %></span>
              </div>
            <% end %>
          </div>

        <% end %>

        <div class="card-actions justify-between items-end mt-4 flex flex-row border-t border-base-content/5 pt-3">
          <!-- Owner Avatar and Edit Button (Bottom Left) -->
          <div class="flex items-center gap-2">
            <% if randomizer.user&.email.present? %>
              <%= image_tag gravatar_url(randomizer.user, size: 32),
                            alt: "#{randomizer.user.display_name}'s avatar",
                            title: "Created by #{randomizer.user.display_name}",
                            class: "w-8 h-8 rounded-full border border-base-content/20" %>
            <% end %>
            
            <% if current_user == randomizer.user %>
              <%= link_to randomizer,
                          class: "text-base-content/50 hover:text-base-content p-1 rounded flex items-center gap-1 transition-colors",
                          title: "Edit",
                          data: { turbo_frame: "_top" } do %>
                <%= icon(:edit, class: "w-4 h-4") %>
              <% end %>
            <% end %>
          </div>

          <!-- Share Button (Bottom Right) -->
          <div class="flex items-center gap-2 relative" data-controller="clipboard" data-clipboard-url-value="<%= randomizer_url(randomizer) %>">
            
            <!-- Copied Notification (Left of button) -->
            <div data-clipboard-target="notification"
                 class="absolute right-full top-1/2 -translate-y-1/2 mr-3 bg-neutral text-neutral-content px-2 py-1 rounded text-xs whitespace-nowrap opacity-0 hidden pointer-events-none transition-all duration-200 z-20 shadow-md">
              Copied!
              <div class="absolute top-1/2 -right-1 -translate-y-1/2 border-4 border-transparent border-l-neutral"></div>
            </div>

            <button data-action="click->clipboard#copy"
                    class="text-primary hover:text-secondary transition flex items-center gap-1 p-2 hover:bg-primary/10 rounded-full"
                    title="Copy link to clipboard">
              <%= icon 'share', variant: :outline, class: "w-5 h-5" %>
            </button>
          </div>
        </div>
      </div>

      <% end %>
    </div>
  <% end %>
</div>
