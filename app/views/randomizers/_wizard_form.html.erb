<%= form_with(model: randomizer, class: "contents", data: { controller: "randomizer-wizard" }) do |form| %>
  <% if randomizer.errors.any? %>
    <div id="error_explanation" class="alert alert-error mb-6">
      <div>
        <h2><%= pluralize(randomizer.errors.count, "error") %> prohibited this randomizer from being saved:</h2>

        <ul class="list-disc ml-6 mt-2">
          <% randomizer.errors.each do |error| %>
            <li><%= error.full_message %></li>
          <% end %>
        </ul>
      </div>
    </div>
  <% end %>

  <!-- Section 1: Randomizer Details -->
  <div class="card-index mb-6">
    <h2 class="font-typewriter text-2xl font-bold text-pencil mb-4">
      <%= t('.randomizer_details') %>
    </h2>

    <div class="my-5">
      <%= form.label :name, class: "label" %>
      <%= form.text_field :name,
                      class: [
                        "input-handwritten w-full",
                        {
                          "border-red-500": randomizer.errors[:name].any?,
                        },
                      ],
                      placeholder: t('.name_placeholder') %>
    </div>

    <div class="my-5">
      <%= form.label :tag_ids, t('.tags_label'), class: "label font-typewriter text-base-content" %>
      <%= hidden_field_tag 'randomizer[tag_ids][]', '' %>
      <div class="flex flex-wrap gap-3 p-4 border-2 border-dashed border-pencil/30 rounded-lg bg-base-100">
        <% Tag.order(:name).each do |tag| %>
          <label class="flex items-center gap-2 cursor-pointer hover:bg-base-200 p-2 rounded transition-colors">
            <%= check_box_tag 'randomizer[tag_ids][]', tag.id, randomizer.tag_ids.include?(tag.id), 
                              class: "checkbox checkbox-sm",
                              id: "randomizer_tag_ids_#{tag.id}" %>
            <span class="font-handwriting text-base"><%= tag.name %></span>
          </label>
        <% end %>
      </div>
      <p class="text-sm text-base-content/60 mt-1 font-handwriting"><%= t('.tags_help') %></p>
    </div>
  </div>

  <!-- Section 2: First Roll -->
  <%= form.fields_for :rolls do |roll_form| %>
    <div class="card-index mb-6">
      <h2 class="font-typewriter text-2xl font-bold text-pencil mb-4">
        <%= t('.first_roll') %>
      </h2>

      <div class="my-5">
        <%= roll_form.label :name, class: "label" %>
        <%= roll_form.text_field :name,
                        class: [
                          "input-handwritten w-full",
                          {
                            "border-red-500": roll_form.object.errors[:name].any?,
                          },
                        ],
                        placeholder: t('.roll_name_placeholder') %>
      </div>

      <div class="my-5">
        <%= render 'rolls/form_dice', form: roll_form, roll: roll_form.object %>
      </div>

      <!-- Section 3: Results -->
      <div class="mt-8">
        <h3 class="font-typewriter text-xl font-bold text-pencil mb-4">
          <%= t('.results') %>
        </h3>

        <% if method == 'upload' %>
          <!-- Upload Screenshots Mode - Results already imported -->
          <% if randomizer.rolls.any? && randomizer.rolls.first.results.any? %>
            <div class="border-2 border-dashed border-pencil/30 rounded-lg p-6 bg-base-100">
              <p class="text-center text-base-content/70 font-handwriting mb-2">
                âœ“ <%= randomizer.rolls.first.results.count %> results imported from screenshots
              </p>
              <p class="text-sm text-center text-base-content/50 font-handwriting">
                You can edit the randomizer name, tags, roll name, and dice above before submitting.
              </p>
            </div>
          <% else %>
            <div class="border-2 border-dashed border-pencil/30 rounded-lg p-6 bg-base-100">
              <p class="text-center text-base-content/70 font-handwriting">
                No results imported yet. You can add them manually after creating the randomizer.
              </p>
            </div>
          <% end %>
        <% else %>
          <!-- Manual Entry Mode -->
          <div data-randomizer-wizard-target="resultsContainer">
            <%= roll_form.fields_for :results do |result_form| %>
              <div class="flex gap-4 mb-4" data-randomizer-wizard-target="resultField">
                <div class="flex-1">
                  <%= result_form.label :name, t('.result_name'), class: "label text-sm" %>
                  <%= result_form.text_field :name,
                                  class: "input-handwritten w-full",
                                  placeholder: t('.result_name_placeholder') %>
                </div>
                <div class="w-32">
                  <%= result_form.label :value, t('.result_value'), class: "label text-sm" %>
                  <%= result_form.number_field :value,
                                  class: "input-handwritten w-full",
                                  placeholder: "1" %>
                </div>
                <div class="flex items-end">
                  <button type="button" 
                          class="btn-doodle-sm text-red-500 hover:text-red-700"
                          data-action="click->randomizer-wizard#removeResult">
                    <%= icon('x', class: "w-5 h-5") %>
                  </button>
                </div>
              </div>
            <% end %>
          </div>

          <button type="button"
                  class="btn-doodle-sm mt-4"
                  data-action="click->randomizer-wizard#addResult">
            <%= icon('plus', class: "w-4 h-4 inline") %>
            <%= t('.add_result') %>
          </button>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- Submit Button -->
  <div class="mt-8">
    <%= form.submit t('.submit'), class: "btn-doodle cursor-pointer" %>
  </div>
<% end %>
