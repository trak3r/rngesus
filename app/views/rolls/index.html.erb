<% content_for :title, "Rolls" %>

<div class="w-full">
  <!-- Tab Content -->
  <%= turbo_frame_tag "rolls" do %>
    <!-- Header Section with Border -->
    <div class="border-b border-base-300 pb-6 mb-8">

      <!-- Tag Filter Pills -->
      <% if Tag.exists? %>
        <div class="w-full">
          <!-- Desktop Filters -->
          <div class="hidden lg:flex flex-wrap gap-2 items-center">
            <span class="text-sm font-semibold mr-2 opacity-70 text-base-content">Filter by:</span>
            <% Tag.order(:name).each do |tag| %>
              <%= link_to tag.name,
                  toggle_tag_url(tag.name, current_tags: @tags),
                  class: "badge #{tag_active?(tag.name, current_tags: @tags) ? 'bg-base-content text-base-100 border-base-content' : 'bg-base-100 text-base-content border-base-content'} font-handwriting text-base hover:bg-base-content hover:text-base-100 transition-colors",
                  data: { turbo_frame: "rolls", turbo_action: "advance" } %>
            <% end %>
            <% if @tags.present? %>
              <%= link_to "Clear filters", rolls_path(tab: @tab, query: params[:query]),
                  class: "text-error hover:text-error/70 font-handwriting text-base underline transition-colors ml-2",
                  data: { turbo_frame: "rolls", turbo_action: "advance" } %>
            <% end %>
          </div>

          <!-- Mobile Accordion -->
          <details class="lg:hidden collapse collapse-arrow border border-base-300 bg-base-100 rounded-box">
            <summary class="collapse-title text-lg font-medium font-handwriting">
              Filter by Tags <%= "(#{@tags.count})" if @tags.present? %>
            </summary>
            <div class="collapse-content">
              <div class="flex flex-wrap gap-2 pt-2">
                <% Tag.order(:name).each do |tag| %>
                  <%= link_to tag.name,
                      toggle_tag_url(tag.name, current_tags: @tags),
                      class: "badge #{tag_active?(tag.name, current_tags: @tags) ? 'bg-base-content text-base-100 border-base-content' : 'bg-base-100 text-base-content border-base-content'} font-handwriting text-base hover:bg-base-content hover:text-base-100 transition-colors",
                      data: { turbo_frame: "rolls", turbo_action: "advance" } %>
                <% end %>
                <% if @tags.present? %>
                  <%= link_to "Clear filters", rolls_path(tab: @tab, query: params[:query]),
                      class: "text-error hover:text-error/70 font-handwriting text-base underline transition-colors ml-2 w-full text-center mt-2 block",
                      data: { turbo_frame: "rolls", turbo_action: "advance" } %>
                <% end %>
              </div>
            </div>
          </details>
        </div>
      <% end %>
    </div>

    <div id="rolls_grid" class="grid grid-cols-[repeat(auto-fill,minmax(24rem,1fr))] gap-4">

      <% if @tab == 'your_rolls' %>
        <!-- New Roll Card (only on 'Your Rolls' tab) -->
        <div class="card-index flex flex-col group p-4 min-h-[220px] transition-transform hover:-rotate-1 bg-primary/8">
          <%= link_to choose_method_rolls_path,
                      class: "flex-1 flex flex-col no-underline text-inherit",
                      data: { turbo_frame: "_top" } do %>

            <h2 class="card-title text-xl font-bold mb-2 font-typewriter border-b border-red-300 pb-1">New Roll</h2>

            <p class="flex-1 text-base-content/70 font-handwriting text-lg">
              Create your own!
            </p>

          <% end %>
        </div>
      <% end %>
      <% if @rolls.empty? %>
        <div class="card-index flex flex-col items-center justify-center p-8 min-h-[220px] border-4 border-dashed border-base-content/20 rounded-box text-base-content/40 rotate-1 select-none grayscale">
          <%= icon 'mood-sad', variant: :outline, class: "w-16 h-16 mb-2 stroke-1 opacity-50" %>
          <p class="font-handwriting text-2xl text-center">
            No rolls found...
          </p>
          <% if params[:query].present? %>
            <p class="font-handwriting text-lg text-center mt-2 opacity-75">
              matching "<%= params[:query] %>"
            </p>
          <% end %>
        </div>
      <% end %>

      <!-- Existing Roll Cards with artwork inserted at random position -->
      <% artwork = random_card_artwork %>
      <% artwork_position = random_artwork_position %>
      <% @rolls.each_with_index do |roll, index| %>
        <% unless @tab == 'your_rolls' %>
          <% if index + 2 == artwork_position %>
            <!-- Artwork Card (randomly positioned, hidden on mobile) -->
            <% offset = artwork_vertical_offset(artwork) %>
            <div class="hidden lg:flex card-index flex-col items-center justify-center p-4 min-h-[220px] max-h-[220px] overflow-hidden transition-transform hover:rotate-1 grayscale hover:grayscale-0 transition-all duration-300">
              <%= image_tag "cards/#{artwork}.png",
                          alt: "#{artwork.titleize}",
                          class: "w-full h-full object-cover",
                          style: (offset > 0 ? "object-position: center #{offset}%" : nil) %>
            </div>
          <% end %>
        <% end %>
        <%= render "roll_card", roll: roll, tab: @tab %>

      <% end %>
    </div>

    <!-- Pagination / Load More -->
    <% if @pagy.next %>
      <div id="load_more" class="flex justify-center mt-8 pb-8">
        <%= link_to "Show More Rolls",
            rolls_path(page: @pagy.next, tab: @tab, query: params[:query], tags: @tags),
            data: { turbo_stream: true },
            class: "btn btn-outline btn-wide font-handwriting text-lg group hover:bg-base-content hover:text-base-100 transition-all" %>
      </div>
    <% end %>
  <% end %>
</div>
