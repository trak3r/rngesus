<%= form_with(model: roll, class: "contents") do |form| %>
  <% if roll.errors.any? %>
    <div id="error_explanation" class="alert alert-error">
      <div>
        <h2><%= pluralize(roll.errors.count, "error") %> prohibited this roll from being saved:</h2>

        <ul class="list-disc ml-6 mt-2">
          <% roll.errors.each do |error| %>
            <li><%= error.full_message %></li>
          <% end %>
        </ul>
      </div>
    </div>
  <% end %>

  <div class="my-5">
    <%= form.label :name, class: "label" %>
    <%= form.text_field :name,
                    class: [
                      "input-handwritten w-full",
                      {
                        "border-red-500": roll.errors[:name].any?,
                      },
                    ] %>
  </div>

  <div class="my-5">
    <%= form.label :tag_ids, "Tags (optional, max 3)", class: "label font-typewriter text-base-content" %>
    <%= hidden_field_tag 'roll[tag_ids][]', '' %>
    <div class="flex flex-wrap gap-3 p-4 border-2 border-dashed border-pencil/30 rounded-lg bg-base-100">
      <% Tag.order(:name).each do |tag| %>
        <label class="flex items-center gap-2 cursor-pointer hover:bg-base-200 p-2 rounded transition-colors">
          <%= check_box_tag 'roll[tag_ids][]', tag.id, roll.tag_ids.include?(tag.id), 
                            class: "checkbox checkbox-sm",
                            id: "roll_tag_ids_#{tag.id}" %>
          <span class="font-handwriting text-base"><%= tag.name %></span>
        </label>
      <% end %>
    </div>
    <p class="text-sm text-base-content/60 mt-1 font-handwriting">Select up to 3 game systems for this roll</p>
  </div>

  <div class="my-5">
    <%= render 'form_dice', form: form, roll: roll %>
  </div>
  
  <div class="my-5" data-controller="nested-fields" data-nested-fields-wrapper-value="roll[results_attributes]">
    <div class="flex items-center justify-between mb-4">
      <h3 class="font-bold text-xl font-typewriter">Results</h3>
      <button type="button" data-action="click->nested-fields#add" class="btn-doodle text-sm">
        <%= t('rolls.wizard_form.add_result') %>
      </button>
    </div>
    
    <template data-nested-fields-target="template">
      <div class="flex items-center gap-4 p-4 border rounded-lg bg-base-100/50" data-nested-field>
        <div class="flex-1">
          <label class="label text-sm">Dice Roll</label>
          <input type="number" name="roll[results_attributes][NEW_RECORD][value]" class="input-handwritten w-full" placeholder="e.g. 20" />
        </div>
        <div class="flex-[3]">
          <label class="label text-sm">Outcome Description</label>
          <input type="text" name="roll[results_attributes][NEW_RECORD][name]" class="input-handwritten w-full" placeholder="e.g. Critical Hit!" />
        </div>
      </div>
    </template>
    
    <div class="space-y-4" data-nested-fields-target="container">
      <%= form.fields_for :results do |result_form| %>
        <div class="flex items-center gap-4 p-4 border rounded-lg bg-base-100/50" data-nested-field>
          <div class="flex-1">
             <%= result_form.label :value, "Dice Roll", class: "label text-sm" %>
             <%= result_form.number_field :value, class: "input-handwritten w-full", placeholder: "e.g. 20" %>
          </div>
          <div class="flex-[3]">
             <%= result_form.label :name, "Outcome Description", class: "label text-sm" %>
             <%= result_form.text_field :name, class: "input-handwritten w-full", placeholder: "e.g. Critical Hit!" %>
          </div>
          <% if result_form.object.persisted? %>
            <div class="flex items-center pt-8">
              <label class="cursor-pointer flex items-center gap-2 text-error">
                <%= result_form.check_box :_destroy, class: "checkbox checkbox-error checkbox-sm" %>
                <span class="text-sm">Delete</span>
              </label>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>

  <div class="inline">
    <%= form.submit "Save Roll", class: "btn-doodle cursor-pointer" %>
  </div>
<% end %>
